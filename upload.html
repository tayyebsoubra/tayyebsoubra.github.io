<!DOCTYPE html>
<html>
<head>
  <title>Upload Video</title>
</head>
<body>
  <h2>Upload Your Video</h2>
  <form id="uploadForm">
    <input type="file" name="file" accept="video/*,image/*" required>
    <button type="submit">Upload</button>
  </form>
  <p id="status"></p>

  <script type="module">
    import { supabase } from './supabaseClient.js'

    const MAX_FILE_SIZE = 25 * 1024 * 1024; // 25 MB

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const file = e.target.file.files[0];
      if (!file) return;

      // Check file size
      if (file.size > MAX_FILE_SIZE) {
        document.getElementById("status").textContent = "File is too large (>25MB)";
        return;
      }

      const teamId = localStorage.getItem("teamId");
      if (!teamId) {
        document.getElementById("status").textContent = "You must log in first";
        return;
      }

      const fileName = `${teamId}_${Date.now()}_${file.name}`; // unique name
      document.getElementById("status").textContent = "Uploading...";

      // Upload to Supabase Storage
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('videos')
        .upload(fileName, file, { upsert: true }); // allow overwriting

      if (uploadError) {
        console.log(uploadError);
        document.getElementById("status").textContent = "Upload failed: " + uploadError.message;
        return;
      }

      const { data: publicURLData, error: urlError } = supabase
        .storage.from('videos')
        .getPublicUrl(fileName);

      if (urlError) {
        console.log(urlError);
        document.getElementById("status").textContent = "Failed to get URL: " + urlError.message;
        return;
      }

      document.getElementById("status").textContent = "Uploaded! Link: " + publicURLData.publicUrl;


      // Save the URL to Supabase DB
      const { error: dbError } = await supabase
        .from('team_uploads')
        .insert([{ team_id: teamId, file_url: publicURL }]);

      if (dbError) {
        document.getElementById("status").textContent = "Failed to save video info: " + dbError.message;
      } else {
        document.getElementById("status").textContent = "Upload successful! Link: " + publicURL;
      }
    });
  </script>
</body>
</html>
